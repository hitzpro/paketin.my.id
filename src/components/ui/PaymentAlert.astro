---
// src/components/ui/PaymentAlert.astro
---

<div id="payment-alert-widget" 
     class="hidden fixed top-24 left-4 z-40 cursor-pointer group animate-in slide-in-from-left duration-500">
    
    <div class="flex items-center gap-3 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border border-orange-200 dark:border-orange-900/50 p-3 pr-4 rounded-2xl shadow-lg hover:shadow-orange-500/20 transition-all hover:scale-105">
        
        <div class="relative flex items-center justify-center w-10 h-10 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-full">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-20"></span>
            <i class="fa-regular fa-clock text-lg"></i>
        </div>

        <div class="flex flex-col">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Menunggu Pembayaran</span>
            <div class="flex items-center gap-2">
                <span id="alert-timer" class="text-sm font-mono font-bold text-gray-800 dark:text-white">00:00</span>
                <span class="text-xs text-orange-500 font-medium group-hover:translate-x-1 transition-transform">
                    Bayar <i class="fa-solid fa-chevron-right text-[10px]"></i>
                </span>
            </div>
        </div>

        <button id="btn-close-alert" class="absolute -top-2 -right-2 bg-gray-200 dark:bg-gray-700 text-gray-500 rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-100 hover:text-red-500 transition-colors">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>
</div>

<script>
    import { API_BASE_URL } from '../../config'; // Jika perlu cek status ke API

    document.addEventListener('astro:page-load', () => {
        const widget = document.getElementById('payment-alert-widget');
        const timerDisplay = document.getElementById('alert-timer');
        const closeBtn = document.getElementById('btn-close-alert');
        
        if (!widget || !timerDisplay) return;

        // 1. Ambil Data dari LocalStorage
        const pendingData = localStorage.getItem('pending_transaction');
        if (!pendingData) return;

        const { id, expiry } = JSON.parse(pendingData);
        
        // 2. Fungsi Update Timer
        const updateWidget = () => {
            const now = Date.now();
            const secondsLeft = Math.floor((expiry - now) / 1000);

            if (secondsLeft <= 0) {
                // Waktu habis, sembunyikan widget & hapus storage
                widget.classList.add('hidden');
                localStorage.removeItem('pending_transaction');
                return;
            }

            const m = Math.floor(secondsLeft / 60);
            const s = secondsLeft % 60;
            timerDisplay.innerText = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
            
            // Tampilkan widget jika masih tersembunyi
            if (widget.classList.contains('hidden')) {
                widget.classList.remove('hidden');
            }
        };

        // Jalankan sekali lalu interval
        updateWidget();
        const interval = setInterval(updateWidget, 1000);

        // 3. Klik Widget -> Ke Halaman Payment
        widget.addEventListener('click', (e) => {
            // Jangan redirect kalau yg diklik tombol close
            if (e.target.closest('#btn-close-alert')) return;
            window.location.href = `/payment/${id}`;
        });

        // 4. Klik Close -> Hilangkan Widget Saja (Storage tetap ada)
        if (closeBtn) {
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Stop event bubbling ke widget
                widget.classList.add('hidden');
                clearInterval(interval);
            });
        }
    });
</script>