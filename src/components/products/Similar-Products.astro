---
import ProductCard from './Product-Card.astro';
import { API_BASE_URL } from '../../config.js';
interface Props {
    currentProductId: number;
    // Category tidak lagi wajib dikirim dari parent, 
    // karena backend akan mencarinya sendiri berdasarkan ID.
    category?: string; 
}

const { currentProductId } = Astro.props;

let similarProducts = [];

try {
    // Panggil Endpoint Backend Baru
    // Gunakan IP 127.0.0.1 agar lebih stabil di Node environment
    const response = await fetch(`${API_BASE_URL}/products/similar/${currentProductId}`);
    
    if (response.ok) {
        const result = await response.json();
        similarProducts = result.data || [];
    }
} catch (error) {
    console.error("Gagal fetch similar products:", error);
}

// Logic Hide Section jika kosong
if (similarProducts.length === 0) {
    return null;
}
---

<section class="mt-16 mb-12">
    <div class="flex items-center gap-2 mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Paket Serupa & Sejenis</h3>
        <span class="text-xl">âœ¨</span>
    </div>

    <div class="flex flex-col md:flex-row md:flex-nowrap gap-4 overflow-x-auto">
        {similarProducts.map((product: any) => (
            <div class="flex-shrink-0 w-full md:w-[260px]">
                <ProductCard 
                    id={product.id} 
                    title={product.product_name} 
                    description={product.description || "Penawaran menarik lainnya."} 
                    price={`Rp ${Number(product.price).toLocaleString('id-ID')}`} 
                    category={product.category}
                    type={product.type} 
                    image={product.image}
                />
            </div>
        ))}
    </div>
</section>
