---
const { productId, totalFormatted, totalPrice } = Astro.props;
---

<div class="bg-slate-50 dark:bg-gray-800/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-700 text-center sticky top-24">
    <p class="text-gray-500 dark:text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">
        Total Pembayaran
    </p>

    <h3 class="text-2xl md:text-3xl font-black text-gray-800 dark:text-white mb-6">
        {totalFormatted}
    </h3>

    <button 
        id="btn-buy-now"
        class="w-full btn btn-primary border-none text-white font-bold py-3.5 rounded-xl hover:brightness-110 active:scale-[0.98] transition-all duration-200 text-base"
        data-product-id={productId}
        data-total-price={totalPrice} 
    >
        Bayar Sekarang
        <i class="fa-solid fa-arrow-right ml-2"></i>
    </button>

    <div class="mt-4 flex items-center justify-center gap-1.5 opacity-60">
        <i class="fa-solid fa-shield-halved text-green-600 dark:text-green-400 text-xs"></i>
        <span class="text-[0.625rem] font-medium text-gray-500 dark:text-gray-400">Garansi uang kembali</span>
    </div>
</div>

<script>
    import { API_BASE_URL } from '../../config';
    import { apiPost } from '../../scripts/utils/api.js';

    document.addEventListener('astro:page-load', () => {
        // ... (Script logika JS tidak perlu diubah karena tidak mengatur CSS layout)
        const btnBuy = document.getElementById('btn-buy-now');
        if (btnBuy) {
            btnBuy.addEventListener('click', async () => {
                const userStr = localStorage.getItem('paketin_user');
                if (!userStr) {
                    if(confirm("Silakan login terlebih dahulu.")) {
                         window.location.href = '/auth/login';
                    }
                    return;
                }

                const user = JSON.parse(userStr);
                const productId = btnBuy.getAttribute('data-product-id');
                const finalPrice = btnBuy.getAttribute('data-total-price');

                if (typeof window['openModal_confirm_buy_modal'] === 'function') {
                    const modalConfirmBtn = document.getElementById('confirm_buy_modal-confirm-btn');
                    if (modalConfirmBtn) {
                        const newBtn = modalConfirmBtn.cloneNode(true);
                        modalConfirmBtn.parentNode.replaceChild(newBtn, modalConfirmBtn);
                        newBtn.addEventListener('click', () => processCheckout(user.id, productId, finalPrice));
                    }
                    window['openModal_confirm_buy_modal']();
                } else {
                    if (confirm("Lanjutkan ke pembayaran?")) {
                        processCheckout(user.id, productId, finalPrice);
                    }
                }
            });
        }

        async function processCheckout(userId, productId, finalPrice) {
            const btnBuy = document.getElementById('btn-buy-now');
            const originalText = btnBuy.innerHTML;
            btnBuy.innerHTML = '<span class="loading loading-spinner"></span> Memproses...';
            btnBuy.disabled = true;
            try {
                const res = await apiPost('/checkout/create', {
                    user_id: userId,
                    product_id: productId,
                    quantity: 1,
                    final_price: finalPrice
                });
                if (res.ok) {
                    if (typeof window.showToast === 'function') window.showToast('Tagihan dibuat!', 'success');
                    setTimeout(() => {
                        window.location.href = `/payment/${res.data.checkout_id}`;
                    }, 500);
                } else {
                    alert('Gagal: ' + res.error);
                    btnBuy.innerHTML = originalText;
                    btnBuy.disabled = false;
                }
            } catch (error) {
                alert("Gagal menghubungi server.");
                btnBuy.innerHTML = originalText;
                btnBuy.disabled = false;
            }
        }
    });
</script>