---
const { productId, totalFormatted, totalPrice } = Astro.props;
---

<div class="bg-slate-50 dark:bg-gray-800/50 rounded-2xl p-6 border border-gray-200 dark:border-gray-700 text-center sticky top-24">
    <p class="text-gray-500 dark:text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">
        Total Pembayaran
    </p>

    <h3 class="text-2xl md:text-3xl font-black text-gray-800 dark:text-white mb-6">
        {totalFormatted}
    </h3>

    <button 
        id="btn-buy-now"
        class="w-full btn btn-primary border-none text-white font-bold py-3.5 rounded-xl hover:brightness-110 active:scale-[0.98] transition-all duration-200 text-base"
        data-product-id={productId}
    >
        Bayar Sekarang
        <i class="fa-solid fa-arrow-right ml-2"></i>
    </button>

    <div class="mt-4 flex items-center justify-center gap-1.5 opacity-60">
        <i class="fa-solid fa-shield-halved text-green-600 dark:text-green-400 text-xs"></i>
        <span class="text-[10px] font-medium text-gray-500 dark:text-gray-400">Garansi uang kembali</span>
    </div>
</div>

<script>
    import { API_BASE_URL } from '../../config';
    document.addEventListener('astro:page-load', () => {
        const btnBuy = document.getElementById('btn-buy-now');
        const API_URL = API_BASE_URL;

        if (btnBuy) {
            btnBuy.addEventListener('click', async () => {
                const userStr = localStorage.getItem('paketin_user');
                if (!userStr) {
                    alert("Silakan login terlebih dahulu untuk membeli paket.");
                    window.location.href = '/auth/login';
                    return;
                }

                const user = JSON.parse(userStr);
                const productId = btnBuy.getAttribute('data-product-id');

                // Modal mode
                if (typeof window['openModal_confirm_buy_modal'] === 'function') {
                    const modalConfirmBtn = document.getElementById('confirm_buy_modal-confirm-btn');
                    if (modalConfirmBtn) {
                        const newBtn = modalConfirmBtn.cloneNode(true);
                        modalConfirmBtn.parentNode.replaceChild(newBtn, modalConfirmBtn);
                        newBtn.addEventListener('click', () => processCheckout(user.id, productId, totalPrice));

                    }
                    window['openModal_confirm_buy_modal']();
                } 
                // Fallback
                else {
                    if (confirm("Lanjutkan ke pembayaran?")) {
                        processCheckout(user.id, productId);
                    }
                }
            });
        }

        async function processCheckout(userId, productId, finalPrice) {
            const btnBuy = document.getElementById('btn-buy-now');
            const originalText = btnBuy.innerHTML;
            btnBuy.innerHTML = '<span class="loading loading-spinner"></span> Memproses...';
            btnBuy.disabled = true;

            try {
                const response = await fetch(`${API_URL}/checkout/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        product_id: productId,
                        quantity: 1,
                        final_price: finalPrice
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    if (typeof window.showToast === 'function') window.showToast('Tagihan dibuat!', 'success');
                    setTimeout(() => {
                        window.location.href = `/payment/${result.checkout_id}`;
                    }, 500);
                } else {
                    alert('Gagal: ' + result.message);
                }

            } catch (error) {
                alert("Gagal menghubungi server.");
            }

            btnBuy.innerHTML = originalText;
            btnBuy.disabled = false;
        }
    });
</script>
